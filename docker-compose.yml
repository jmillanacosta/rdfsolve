# docker-compose.yml — rdfsolve full-stack (Flask API + frontend)
#
# The frontend (TypeScript web components) lives as a git submodule
# at ./frontend/ and is built inside a multi-stage Docker image
# alongside the Python/Flask backend.
#
# Usage:
#   git submodule update --init          # ensure frontend code is present
#   docker compose up --build            # build & start
#   open http://localhost:8000           # app is served here
#
# Override the port:
#   PORT=9000 docker compose up --build
#
# To mine more schemas into docker/schemas/:
#   python scripts/seed_schemas.py --names chembl drugbank

services:
  rdfsolve:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: rdfsolve
    volumes:
      # Persist SQLite database across container restarts
      - db-data:/app/data
      # Mount schemas directory — add .jsonld files here without rebuilding
      - ./docker/schemas:/app/schemas:ro
    environment:
      - DATABASE_PATH=/app/data/rdfsolve.db
      - SCHEMA_IMPORT_DIR=/app/schemas
      - FRONTEND_DIST=/app/frontend
      - CORS_ORIGINS=*
      - SPARQL_TIMEOUT=60
      - FLASK_DEBUG=0
      - PORT=${PORT:-8000}
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    healthcheck:
      test: ["CMD", "python", "-c", "import os,urllib.request; urllib.request.urlopen(f'http://localhost:{os.environ.get(\"PORT\",\"8000\")}/api/health')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  db-data:
